# 実装計画書

## 概要
「第2の脳」RAGシステムの段階的実装計画。MVPから始めて、徐々に機能を拡張していく。

## Phase 1: MVP実装（1-2週間）

### 目標
最小限の機能で動作するシステムを構築し、基本的な検索と登録を可能にする。

### 実装項目

#### Week 1: コア機能
1. **プロジェクト構造のセットアップ**
   ```bash
   rag_documents/
   ├── setup.py
   ├── requirements.txt
   ├── rag/
   │   ├── __init__.py
   │   ├── core/
   │   │   ├── database.py    # ChromaDB基本操作
   │   │   ├── vectorizer.py  # 埋め込みモデル
   │   │   └── chunker.py     # テキスト分割
   │   └── cli/
   │       └── main.py        # 基本CLIコマンド
   ```

2. **基本機能の実装**
   - ChromaDBのセットアップと初期化
   - Markdownファイルの読み込み
   - テキストのチャンク分割（固定サイズ）
   - ベクトル化と保存
   - 基本的なベクトル検索

3. **CLIコマンド（最小限）**
   ```bash
   rag index <file>     # ファイルを登録
   rag search <query>   # 検索実行
   ```

#### Week 2: MCPサーバー基本実装
1. **MCPサーバーのセットアップ**
   ```python
   rag/mcp/
   ├── __init__.py
   ├── server.py       # MCPサーバー本体
   └── handlers.py     # ツールハンドラー
   ```

2. **基本ツールの実装**
   - `rag_search`: 基本検索
   - `rag_index`: ファイル登録

3. **ClaudeCode連携テスト**
   - claude_desktop_config.jsonの設定
   - 基本動作確認

### 成果物
- [ ] 基本的な検索・登録が動作するCLIツール
- [ ] ClaudeCodeから検索できるMCPサーバー
- [ ] インストール手順書

## Phase 2: 機能拡張（2-3週間）

### 目標
実用的なレベルまで機能を充実させる。

### 実装項目

#### Week 3: 検索機能の強化
1. **ハイブリッド検索**
   - キーワード検索の実装
   - ベクトル検索との統合
   - スコアリング調整

2. **メタデータ管理**
   - プロジェクトID
   - カテゴリー、タグ
   - 作成日時、更新日時

3. **検索結果の改善**
   - コンテキスト表示
   - ハイライト機能
   - 位置情報（行番号）

#### Week 4: CLI機能拡張
1. **追加コマンド**
   ```bash
   rag delete          # 削除機能
   rag sync           # プロジェクト同期
   rag config         # 設定管理
   ```

2. **出力形式**
   - JSON出力対応
   - テーブル表示
   - カラー出力（Rich使用）

3. **インタラクティブモード**
   - 対話的検索
   - 履歴機能
   - 補完機能

#### Week 5: MCP機能拡張
1. **追加ツール**
   - `rag_suggest`: コンテキスト提案
   - `rag_delete`: 削除機能
   - `rag_sync`: 同期機能

2. **リソース提供**
   - プロジェクト一覧
   - 統計情報

3. **エラーハンドリング**
   - 適切なエラーメッセージ
   - リトライ機能

### 成果物
- [ ] ハイブリッド検索
- [ ] メタデータフィルタリング
- [ ] 充実したCLIコマンド
- [ ] 完全なMCPツールセット

## Phase 3: 外部連携（3-4週間）

### 目標
外部データソースとの連携を実現し、「第2の脳」として完成させる。

### 実装項目

#### Week 6-7: 外部データソース対応
1. **キャッシュシステム**
   - TTL管理
   - 重複排除
   - 更新戦略

2. **外部データ登録API**
   - Jira/Confluence形式対応
   - Web検索結果の保存
   - メタデータ管理

3. **ClaudeCodeフック連携**
   - 自動インデックス
   - コミット時同期

#### Week 8: 最適化と改善
1. **パフォーマンス最適化**
   - バッチ処理
   - 非同期処理
   - インデックス最適化

2. **ユーザビリティ改善**
   - セットアップスクリプト
   - 設定ウィザード
   - ドキュメント充実

### 成果物
- [ ] 外部データソース連携
- [ ] キャッシュ管理機能
- [ ] 自動化スクリプト
- [ ] 完全なドキュメント

## 実装優先順位

### 必須（Must Have）
1. ✅ 基本的な検索機能
2. ✅ ファイル登録機能
3. ✅ CLIツール
4. ✅ MCPサーバー基本機能

### 重要（Should Have）
1. ⏳ ハイブリッド検索
2. ⏳ メタデータ管理
3. ⏳ プロジェクト分離
4. ⏳ 削除機能

### あれば良い（Nice to Have）
1. 📅 外部データソース連携
2. 📅 インタラクティブモード
3. 📅 キャッシュ管理
4. 📅 Web UI

## 技術的決定事項

### 確定事項
- **言語**: Python 3.10+
- **ベクトルDB**: ChromaDB
- **埋め込みモデル**: sentence-transformers/multilingual-e5-base
- **CLIフレームワーク**: Click
- **MCP SDK**: 公式Python SDK

### 検討事項
- **非同期処理**: asyncioの使用範囲
- **設定管理**: YAML vs TOML
- **ログ**: 標準logging vs structlog
- **テスト**: pytest vs unittest

## リスクと対策

### 技術的リスク
1. **MCPサーバーの安定性**
   - 対策: 段階的実装、十分なテスト

2. **大量データでのパフォーマンス**
   - 対策: インデックス最適化、チャンクサイズ調整

3. **日本語処理の精度**
   - 対策: 多言語対応モデルの使用

### 運用リスク
1. **データ損失**
   - 対策: 定期バックアップ機能

2. **設定の複雑さ**
   - 対策: デフォルト設定の充実

## 成功指標

### 定量的指標
- 検索レスポンス: 1秒以内
- インデックス速度: 100ファイル/分
- メモリ使用量: 1GB以下

### 定性的指標
- ClaudeCodeからシームレスに使える
- セットアップが5分以内で完了
- 日常的に使いたくなる

## 次のステップ

1. **環境構築**
   ```bash
   mkdir -p rag_documents/rag/{core,cli,mcp}
   touch setup.py requirements.txt
   ```

2. **依存関係インストール**
   ```bash
   pip install chromadb sentence-transformers click mcp
   ```

3. **最初のコード実装**
   - core/database.py から開始
   - 基本的なCRUD操作を実装

---

*この計画は柔軟に調整可能です。実装を進めながら、必要に応じて優先順位を見直します。*